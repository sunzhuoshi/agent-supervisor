name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3) - See VERSIONING.md'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate and update version in AgentSupervisor.csproj
      run: |
        NEW_VERSION="${{ inputs.version }}"
        OLD_VERSION=$(grep -oP '<Version>\K[^<]+' AgentSupervisor.csproj)

        echo "Current version: $OLD_VERSION"
        echo "New version: $NEW_VERSION"

        # Function to compare semantic versions
        version_gt() {
          test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
        }

        if ! version_gt "$NEW_VERSION" "$OLD_VERSION"; then
          echo "Error: New version ($NEW_VERSION) must be greater than" \
            "current version ($OLD_VERSION)"
          exit 1
        fi

        echo "Version validation passed. Updating version..."
        sed -i "s|<Version>.*</Version>|<Version>${NEW_VERSION}</Version>|" \
          AgentSupervisor.csproj

    - name: Commit and push changes
      run: |
        git add AgentSupervisor.csproj
        git commit -m "Bump version to ${{ inputs.version }}"
        git tag v${{ inputs.version }}
        git push origin main v${{ inputs.version }}
